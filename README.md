# Организация автоматического резервного копирования при помощи XtraBackup

## Полный цикл резервного копирования

### Полный бэкап (Full Backup)

#### Создание полного бэкапа (Full Backup)

Для создания бэкапа, требуется запустить xtrabackup с опцией --backup. Также можно указать опцию --target-dir, которая указывает на директорию, где будет создан бэкап. Если директория для создания бэкапа не существует, xtrabackup создаст ее. Если директория существует и пустая, то xtrabackup также создаст бэкап. Xtrbackup не перезапишет существющие файлы, бэкап не будет создан с ошибкой operating system error 17, file exists.

Пример команды для создания полного резервного бэкапа всех баз

xtrabackup --backup --datadir=/var/lib/mysql/ --target-dir=/data/backups/mysql/

Выполнение данной команды создаст полный бэкап всех баз, которые находятся в директории /var/lib/mysql,
в директории /data/backups/mysql/

Во время процесса резервного копирования, вы можете наблюдать большой объем вывода информации о том какие файлы были скопированы, какие логи были просканированны
и также скопированы. Ниже пример того как это может выглядеть:

>> log scanned up to (3646475465483)
>> log scanned up to (3646475517369)
>> log scanned up to (3646475581716)
>> log scanned up to (3646475636841)
>> log scanned up to (3646475718082)
>> log scanned up to (3646475988095)
>> log scanned up to (3646476048286)
>> log scanned up to (3646476102877)
>> log scanned up to (3646476140854)
[01] Copying /var/lib/mysql/var/ibdata1
     to /var/lib/mysql/Backups/2020-12-07_21-11-15/ibdata1
[01]        ...done

После того как выполнение полного резервного копирования завершено, директория для создания полных бэкапов будет содержать примерно следующую информацию.
Предположим, что есть база данных test с одной InnoDB таблицей test.tbl1 и используется опция MySQL innodb_file_per_table:

/data/backups/mysql/ibdata1
/data/backups/mysql/test
/data/backups/mysql/test/tbl1.ibd
/data/backups/mysql/xtrabackup_checkpoints
/data/backups/mysql/xtrabackup_logfile

Создание полной резервной копии может занимать длительное время, это зависит от того какой объем базы или баз.
Абсолютно безопасно отменить создание полного резервного копирования в любой момент времени, потому что при создании полного бэкапа
файлы с базами данных не модифирцируются.

Следующим шагом будет подготовка созданного бэкапа для восстановления.

#### Подготовка полного бэкапа для восстановления

После того как вы создали полную резервную копию c опцией --backup, следюущий шаг это подготовка к восстановлению.
Файлы информационной базы не консистентны на текущий момент времени, до того момента пока они не будут подготовлены к восстановлению,
потому что они были скопированы в разное время, когда программа была запущена и также они могли быть изменены в процессе создания резервной копии.
Если вы попробуете запустить MySQL с этими данными, то он он обнаружит, что данные повреждены и не запустится на поврежденных файлах.
Опция --prepare позволяет сделать файлы идеально консистентными в единый момент времени, после этого можно будет запускать файл используя
подготовленные файлы базы данных и MySQL после этого запустится корректно.

Использовать опцию --prepare довольно просто: необходимо запустить команду xtrabackup с опцией --prepare и указать путь к директории --target-dir.

Пример команды для подготовки полной резервной копии для восстановления:

xtrabackup --prepare --target-dir=/data/backups/mysql/

Когда команда завершит свою работу, вы увидите сообщение "InnoDB shutdown" с последующим текстом примерно следующего содержания:

101107 16:40:15  InnoDB: Shutdown completed; log sequence number <LSN>
     
Не рекомендуется прерывать процесс подготовки бэкапа, это может повредить файлы, которые были созданы в процессе резервного копирования.

Если вы планируете создать полный бэкап, которые впоследствии будет использоваться для создания инкрементных бэкпов, вы должны использовать опцию 
--apply-log-only во время подготовки бэкапа или вы не сможете применить инкрементный бэкап к полному бэкапу.

Пример команды для подготовки полного бэкапа, который впоследствии будет использоваться для создания инкрментных:

xtrabackup --prepare --apply-log-only --target-dir=/data/backups/mysql/

#### Восстановление полного бэкапа

Xtrabackup не содержит в себе функциональности для восстановления бэкапа.
Это задача на усмотрение пользователя. Вы можете использовать cp или rsync для восстановления файлов.
После восстановления необходимо проверить, что восстановленные файлы имеют корректного владельца и права (владелец и группа должны быть mysql)

Пример команды восстановления полного бэкапа:

cp -Rp /data/backups/mysql /var/lib/mysql/

В данном случае /data/backups/mysql это директория в которой находится полная резервная копия,
а /var/lib/mysql это директория в которую будет восстановлена резервная копия.

Обратите внимание, что при восстановлении необходимо полностью удалять директорию, которую требуется восстановить.

После восстановления, требуется указать корректного владельца и группу:

chown -R mysql:mysql /var/lib/mysql






